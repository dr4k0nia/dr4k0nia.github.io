<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Writing a simple Unpacker" /><meta property="og:locale" content="en" /><meta name="description" content="Unpacking simple protections of common confuserex mods and other open source obfuscators. This write up was made for beginners, so if you are an experienced reverse engineer its probably not for you. Basic knowledge of C# and CIL is assumed. Keep in mind that the concepts and code shown are my approach, it can be done in different ways for example using emulation." /><meta property="og:description" content="Unpacking simple protections of common confuserex mods and other open source obfuscators. This write up was made for beginners, so if you are an experienced reverse engineer its probably not for you. Basic knowledge of C# and CIL is assumed. Keep in mind that the concepts and code shown are my approach, it can be done in different ways for example using emulation." /><link rel="canonical" href="https://dr4k0nia.github.io/posts/Writing-a-simple-unpacker/" /><meta property="og:url" content="https://dr4k0nia.github.io/posts/Writing-a-simple-unpacker/" /><meta property="og:site_name" content="dr4k0nia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-10-31T14:46:24+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Writing a simple Unpacker" /><meta name="twitter:site" content="@dr4k0nia" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2020-10-31T14:46:24+00:00","datePublished":"2020-10-31T14:46:24+00:00","description":"Unpacking simple protections of common confuserex mods and other open source obfuscators. This write up was made for beginners, so if you are an experienced reverse engineer its probably not for you. Basic knowledge of C# and CIL is assumed. Keep in mind that the concepts and code shown are my approach, it can be done in different ways for example using emulation.","headline":"Writing a simple Unpacker","mainEntityOfPage":{"@type":"WebPage","@id":"https://dr4k0nia.github.io/posts/Writing-a-simple-unpacker/"},"url":"https://dr4k0nia.github.io/posts/Writing-a-simple-unpacker/"}</script><title>Writing a simple Unpacker | dr4k0nia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dr4k0nia"><meta name="application-name" content="dr4k0nia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/51999910?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">dr4k0nia</a></div><div class="site-subtitle font-italic">Developer & Reverse-Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust" title="Toggle theme"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dr4k0nia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/dr4k0nia" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dr4k0nia','pm.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Writing a simple Unpacker</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Writing a simple Unpacker</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1604155584" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 31, 2020 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/dr4k0nia">dr4k0nia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1635 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p>Unpacking simple protections of common confuserex mods and other open source obfuscators. This write up was made for beginners, so if you are an experienced reverse engineer its probably not for you. Basic knowledge of C# and CIL is assumed. Keep in mind that the concepts and code shown are my approach, it can be done in different ways for example using emulation.</p><h3 id="contents"><span class="mr-2">Contents:</span><a href="#contents" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><ol><li>Getting started<li>Deconstructing protections<li>Credits</ol><h2 id="1-getting-started"><span class="mr-2">1. Getting started</span><a href="#1-getting-started" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p> I got the idea of writing a custom unpacker to solve mutations/protections that could not be solved by de4dot after coming across more &amp; more ConfuserEx modifications using "custom" protections that could not be unpacked by de4dot, an example would be using sizeof() for integer mutations. Those are quickly removed but doing it manually is quite time wasting. So I decided to write a tool for it.</p><p> I chose AsmResolver as an assembly editing library. I started out by taking a look at the protections that I wanted to fix. To remove a protection we will first need to understand how the protection works. In my case the source code of most of the protections themselves was available in quite a few public ConfuserEx forks. But even if the source is not available we can determine how a protection works by decompiling a sample.</p><h2 id="20-deconstructing-sizeof-mutations"><span class="mr-2">2.0 Deconstructing: Sizeof Mutations</span><a href="#20-deconstructing-sizeof-mutations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>A very common example are <code class="language-plaintext highlighter-rouge">sizeof()</code> mutations found in numerous public ConfuserEx forks. The most basic version looks somewhat like this:</p><p>Lets say our original code looks like this:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">256</span>
</pre></table></code></div></div><p>Now we run it through an obfuscator using <code class="language-plaintext highlighter-rouge">sizeof()</code> mutations, the result could look like this:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">260</span> <span class="p">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">int</span><span class="p">);</span>
</pre></table></code></div></div><p>The simple variable has been converted into an expression, <code class="language-plaintext highlighter-rouge">sizeof(int)</code> will return a value of 4 <a href="https://docs.microsoft.com/en-us/dotnet/csharp/language-reference/operators/sizeof">(sizeof msdn)</a>. So its basically just <code class="language-plaintext highlighter-rouge">int a = 260 - 4</code>. <code class="language-plaintext highlighter-rouge">&lt;br&gt;</code>While de4dot will simplify <code class="language-plaintext highlighter-rouge">int a = 260 - 4</code> to <code class="language-plaintext highlighter-rouge">int a = 256</code> it will not simplify the expression containing <code class="language-plaintext highlighter-rouge">sizeof(int)</code> so to fix this we will need to get rid of the sizeof.</p><p>To understand how we can remove the sizeof from our expression we will first need to take a look at the CIL Code of our expression.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>ldc.i4 260
sizeof System.Integer
sub
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">ldc.i4</code> OpCode with the operand value of 260 initializes an integer with said value.<li><code class="language-plaintext highlighter-rouge">sizeof</code> OpCode with the operand System.Integer represents <code class="language-plaintext highlighter-rouge">sizeof(int)</code> which will result in a integer value of 4.<li><code class="language-plaintext highlighter-rouge">sub</code> OpCode stands for subract (-).</ul><p><br /> To get rid of the sizeof we will resolve its resulting integer value and replace the sizeof OpCode with an integer <em>(ldc.i4 OpCode)</em>. I will explain the concept below:</p><ol><li>Get all Types and their methods<li>Foreach method that has a CILBody check if the instructions contain sizeof OpCode(s)<li>For every found sizeof OpCode call <code class="language-plaintext highlighter-rouge">GetImpliedMemoryLayout(is32Bit true/false)</code>¹ <em>(feature of AsmResolver)</em> If you dont use AsmResolver you can run a dynamic method that calls <code class="language-plaintext highlighter-rouge">sizeof(T)</code>. T being the the operand type of the sizeof OpCode².<li>Replace the sizeof OpCode with an ldc.i4 OpCode and set its operand to the value thats returned by GetImpliedMemoryLayout.<li>Call OptimizeMacros() to optimize CIL like <code class="language-plaintext highlighter-rouge">ldc.i4 1</code> to <code class="language-plaintext highlighter-rouge">ldc.i4.1</code></ol><p>My full code can be found <a href="https://github.com/dr4k0nia/Unscrambler/blob/master/Unscrambler/Features/MethodFeatures/SizeOfReplace.cs">here</a></p><p><em><font size="2"> 1. This assumes that you have before determined if the code is 32bit or not. If the code is 32bit call the method with the parameter true else use false.</font></em> <br /> <em><font size="2"> 2. This requires reflection while AsmResolvers method is completely static. </font></em></p><h2 id="21-deconstructing-locals-to-fields"><span class="mr-2">2.1 Deconstructing: Locals to Fields</span><a href="#21-deconstructing-locals-to-fields" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Another example found in numerous forks of ConfuserEx is the locals to fields protection it basically does what the name says it converts locals to field. Since de4dot will not simplify expressions that include field values we want to restore the fields back to locals.</p><p>The examples I have found during my research mostly work somewhat like this:</p><ul><li>OpCodes like stloc, ldloc and ldloca are replaced with their field equivalents stsfld, ldsfld, ldsflda<li>The replacement fields are created in the global type¹, <code class="language-plaintext highlighter-rouge">&lt;Module&gt;</code> by default. These fields will have the attributes: public and static.<li>(Optional) Sometimes one field is used to replace multiple locals of the same type, for example all locals of the type int are replaced with the same field.</ul><p><em><font size="2"> 1. The fields could also be created in any other public type, but all forks I looked at used the global type. </font></em></p><p>Lets say the original code looks like this</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kt">string</span> <span class="n">text</span> <span class="p">=</span> <span class="nf">SomeMethodThatReturnsAString</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(</span><span class="n">text</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(</span><span class="n">text</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>After running it through an obfuscator using locals 2 fields we will receive something like this. Instead of to a local the string returned by <code class="language-plaintext highlighter-rouge">SomeMethodThatReturnsAString()</code> is now assigned to a field thats intialized in the global type.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="p">&lt;</span><span class="n">Module</span><span class="p">&gt;.</span><span class="n">Field0</span> <span class="p">=</span> <span class="nf">SomeMethodThatReturnsAString</span><span class="p">();</span>
<span class="k">if</span> <span class="p">(&lt;</span><span class="n">Module</span><span class="p">&gt;.</span><span class="n">Field0</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">Console</span><span class="p">.</span><span class="nf">WriteLine</span><span class="p">(&lt;</span><span class="n">Module</span><span class="p">&gt;.</span><span class="n">Field0</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Looking at the IL of the above shown code shows how minor these changes actually are. First we will look at the CIL Code of our original code. <em>(code is simplified)</em></p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>call string C::SomeMethodThatReturnsAString()
stloc.0
ldloc.0 
callvirt instance string [mscorlib]System.String::get_Length()
ldc.i4.0
...
ldloc.0
call void [System.Console]System.Console::WriteLine(string)
...
</pre></table></code></div></div><p>If we compare this to the obfuscated CIL Code it looks very similar. The OpCodes that set and load our locals value have been replaced with their field equivalents.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre>call string C::SomeMethodThatReturnsAString()
stsfld string &lt;Module&gt;::Field0
ldsfld string &lt;Module&gt;::Field0
callvirt instance int32 [System.Private.CoreLib]System.String::get_Length()
ldc.i4.0
...
ldsfld string &lt;Module&gt;::Field0
call void [System.Console]System.Console::WriteLine(string)
...
</pre></table></code></div></div><p>So to convert the fields back to locals we will do the following:</p><ol><li>Search for fields that match the criteria (!private and static, has no default value, only used in one method) in the global type<li>Check all method bodies for OpCodes were the operandtype is InlineField and the operand is a FieldDefinition<li>Check if the matched FieldDefinition is one of the fields that we gathered from the global type:<ul><li>if true: Add new local with the same type as the fields type, change all calls to the matched field with the newly created local. Store the replaced field and new local in a dictionary. Check if there is already a local for the matched field. If there is already an entry for the field use the entry from the dictionary.<li>if false: skip</ul><li>(Optional) Call OptimizeMacros()<li>(Optional) Remove all fields that were replaced. In my case the ones from the before used dictionary.</ol><p>My full code can be found <a href="https://github.com/dr4k0nia/Unscrambler/blob/master/Unscrambler/Features/LocalsToFieldRemover.cs">here</a></p><h2 id="22-deconstructing-math-mutations"><span class="mr-2">2.2 Deconstructing: Math Mutations</span><a href="#22-deconstructing-math-mutations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Another protection that can be seen quite often in modified ConfuserEx versions, or standalone obfuscators. Are math mutations, using System.Math methods like <code class="language-plaintext highlighter-rouge">Floor()</code> and <code class="language-plaintext highlighter-rouge">Ceiling()</code> to generate expressions or replace simple integers.</p><p>We will start with the original code again:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="m">256</span><span class="p">;</span>
</pre></table></code></div></div><p>Now the obfuscated one. As you can see its quite hard to guess the original number of our integer now.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">int</span> <span class="n">a</span> <span class="p">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">Math</span><span class="p">.</span><span class="nf">Floor</span><span class="p">(</span><span class="m">102402.0</span><span class="p">)</span> <span class="p">-</span> <span class="m">102146</span><span class="p">;</span>
</pre></table></code></div></div><p>What the obfuscator has done is create an expression that will result in our original integer. I will not go in to the details of how that is achieved as it is not that important for unpacking this protection. Lets look at the CIL Code of the obfuscated snippet.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>ldc.r8 102402
call float64 [System.Private.CoreLib]System.Math::Floor(float64)
conv.i4
ldc.i4 102146
sub
</pre></table></code></div></div><ul><li><code class="language-plaintext highlighter-rouge">ldc.r8</code> OpCode represents the parameter supplied to <code class="language-plaintext highlighter-rouge">Math.Floor()</code> its operand is the value<li><code class="language-plaintext highlighter-rouge">call</code> OpCode will call <code class="language-plaintext highlighter-rouge">Math.Floor()</code> with the above supplied value<li><code class="language-plaintext highlighter-rouge">conv.i4</code> OpCode casts the result of <code class="language-plaintext highlighter-rouge">Math.Floor()</code> to integer. Which is required since the second value of the expression is an integer (ldc.i4)<li><code class="language-plaintext highlighter-rouge">ldc.i4</code> OpCode pushes an integer with the value of its operand onto the stack<li><code class="language-plaintext highlighter-rouge">sub</code> OpCode stands for subtract (-)</ul><p>In order to make this fixable by de4dot we will need to get rid of the <code class="language-plaintext highlighter-rouge">Math.Floor()</code> so what we will do to archieve this is the following:</p><ol><li>Check method bodies for instructions which operand is a MemberRef with the DeclaringTypes FullName equal to System.Math<li>Use Reflection to resolve the method using the resolved MemberRefs MetadataToken (make sure to resolve it from the original System.Math class)¹<li>Check the methods parameter count<li>Get the parameters required from the instructions operands, and Nop the instructions. Implement a check that only includes constant types if the obtained params are not a constant type continue (skip further processing)<li>Invoke the method with the paramters obtained before<li>Replace the call instruction with the OpCode related to the return type of our math function in this case ldc.r8 and set its operand to the result returned by the invoked method</ol><p><em><font size="2">1. This will fail if the target app uses a different framework, to do it properly we would have to resolve the target framework and use its math class. Fix will be added later</font></em></p><p>My full code can be found <a href="https://github.com/dr4k0nia/Unscrambler/blob/master/Unscrambler/Features/MethodFeatures/MathReplace.cs">here</a></p><h2 id="23-deconstructing-calls-to-calli"><span class="mr-2">2.3 Deconstructing: Calls to Calli</span><a href="#23-deconstructing-calls-to-calli" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Calls to Calli can be found in most ConfuserEx forks however the implementation thats commonly used is not very effective.</p><p>For this example we will skip looking at the C# Code and checkout the CIL Code instead. Lets start with the original code</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>call void [System.Windows.Forms]System.Windows.Froms.Application::EnableVisualStyles()
</pre></table></code></div></div><p>If we look at the CIL Code produced by the calls to calli protection, we can see that the ldftn OpCodes operand is the same as the call OpCodes operand in the unobfuscated code, with a little thinking it is pretty obvious how simple the fix will be.</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>ldftn void [System.Windows.Forms]System.Windows.Froms.Application::EnableVisualStyles()
calli void()
</pre></table></code></div></div><p>To get rid of the calli protection we will do the following:</p><ol><li>Search method bodies for calli OpCodes that are lead by ldftn OpCodes<li>Remove the calli OpCode and Change the ldftn OpCode to call</ol><p>My full code can be found <a href="https://github.com/dr4k0nia/Unscrambler/blob/master/Unscrambler/Features/MethodFeatures/CalliReplace.cs">here</a></p><h2 id="3-credits"><span class="mr-2">3. Credits</span><a href="#3-credits" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><ul><li><a href="https://github.com/anonymoosere">AnonymooseRE</a> For helping out with Unscrambler and answering a lot of my questions<li><a href="https://github.com/Washi1337/AsmResolver">Washi</a> For AsmResolver and answering my questions</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dotnet/'>dotnet</a>, <a href='/categories/reverse-engineering/'>reverse-engineering</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Writing+a+simple+Unpacker+-+dr4k0nia&url=https%3A%2F%2Fdr4k0nia.github.io%2Fposts%2FWriting-a-simple-unpacker%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NixImports-a-NET-loader-using-HInvoke/">NixImports a .NET loader using HInvoke</a><li><a href="/posts/Analysing-a-sample-of-ArechClient2/">Analysing A Sample Of Arechclient2</a><li><a href="/posts/String-Obfuscation-The-Malware-Way/">String Obfuscation The Malware Way</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Taking-a-look-at-AntiDumps/"><div class="card-body"> <em class="small" data-ts="1629816384" data-df="ll" > Aug 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Taking a look at AntiDumps</h3><div class="text-muted small"><p> After developing a runtime packer in the last post, I tinkered with anti dumping techniques using PE Header manipulation. In this post I will talk about different approaches and take a look at the ...</p></div></div></a></div><div class="card"> <a href="/posts/Some-thoughts-on-making-a-crackme/"><div class="card-body"> <em class="small" data-ts="1643148804" data-df="ll" > Jan 25, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Some thoughts on making a crackme</h3><div class="text-muted small"><p> In the last few weeks, I’ve been taking a closer look at crackmes, especially beginner focused ones. And noticed a few things that I think many new developers get wrong. Therefore this is a little ...</p></div></div></a></div><div class="card"> <a href="/posts/Unpacking-OriginLogger/"><div class="card-body"> <em class="small" data-ts="1663685184" data-df="ll" > Sep 20, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unpacking OriginLogger Builder</h3><div class="text-muted small"><p> Unpacking OriginLogger Builder OriginLogger is a keylogger that shares a lot of similarities with the well-known Agent Tesla malware. Today I will take a look at their builder and unpack it. A lit...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Homoglyph-Obfuscation/" class="btn btn-outline-nord" prompt="Older"><p>Homoglyph Obfuscation</p></a> <a href="/posts/Writing-a-Packer/" class="btn btn-outline-nord" prompt="Newer"><p>Writing a Packer</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/dr4k0nia">dr4k0nia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
