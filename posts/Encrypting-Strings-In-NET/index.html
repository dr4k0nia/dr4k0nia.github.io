<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Encrypting strings in .NET" /><meta property="og:locale" content="en" /><meta name="description" content="Implementing custom string encryption for .NET binaries utilizing an XOR-based cipher and AsmResolver. Encrypting strings is a common practice to slow down static analysis or evade automatic analysis, in this blog post I will explain how I build my own binary-level string obfuscator in C# .NET 6. The full code of the project can be found here." /><meta property="og:description" content="Implementing custom string encryption for .NET binaries utilizing an XOR-based cipher and AsmResolver. Encrypting strings is a common practice to slow down static analysis or evade automatic analysis, in this blog post I will explain how I build my own binary-level string obfuscator in C# .NET 6. The full code of the project can be found here." /><link rel="canonical" href="https://dr4k0nia.github.io/posts/Encrypting-Strings-In-NET/" /><meta property="og:url" content="https://dr4k0nia.github.io/posts/Encrypting-Strings-In-NET/" /><meta property="og:site_name" content="dr4k0nia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-10-15T19:27:24+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Encrypting strings in .NET" /><meta name="twitter:site" content="@dr4k0nia" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2022-10-15T19:27:24+00:00","datePublished":"2022-10-15T19:27:24+00:00","description":"Implementing custom string encryption for .NET binaries utilizing an XOR-based cipher and AsmResolver. Encrypting strings is a common practice to slow down static analysis or evade automatic analysis, in this blog post I will explain how I build my own binary-level string obfuscator in C# .NET 6. The full code of the project can be found here.","headline":"Encrypting strings in .NET","mainEntityOfPage":{"@type":"WebPage","@id":"https://dr4k0nia.github.io/posts/Encrypting-Strings-In-NET/"},"url":"https://dr4k0nia.github.io/posts/Encrypting-Strings-In-NET/"}</script><title>Encrypting strings in .NET | dr4k0nia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dr4k0nia"><meta name="application-name" content="dr4k0nia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/51999910?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">dr4k0nia</a></div><div class="site-subtitle font-italic">Developer & Reverse-Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust" title="Toggle theme"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dr4k0nia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/dr4k0nia" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dr4k0nia','pm.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Encrypting strings in .NET</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Encrypting strings in .NET</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1665862044" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Oct 15, 2022 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/dr4k0nia">dr4k0nia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1665 words"> <em>9 min</em> read</span></div></div></div><div class="post-content"><p>Implementing custom string encryption for .NET binaries utilizing an XOR-based cipher and AsmResolver. Encrypting strings is a common practice to slow down static analysis or evade automatic analysis, in this blog post I will explain how I build my own binary-level string obfuscator in C# .NET 6. The full code of the project can be found <a href="https://github.com/dr4k0nia/XorStringsNET">here.</a></p><h2 id="concept-and-structure"><span class="mr-2">Concept and Structure</span><a href="#concept-and-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To begin with, I will explain the concept of my implementation. The following points had to be considered:</p><ul><li>A unique XOR key per string<li>Only one universal decryption method<li>The decryption method should have as few parameters as possible<li>Parameters of the decryption method should be encrypted or encoded</ul><p>In order to include a unique XOR key per string and reduce the number of parameters needed for the decryption method, some metadata is required. The metadata per string includes the length of the encrypted data and the XOR key to decrypt that data. Using this format all data can be stored in one single data blob. To get a string from the data blob we only need the offset at which the formatted data starts. From that offset, we parse the metadata reading the length first and then the XOR key.</p><p>Additionally to the string data, another XOR key in form of an int is added to the beginning of the data blob. This key serves as the global XOR key used exclusively to decrypt parameters passed to the decryption method.</p><div class="table-wrapper"><table><thead><tr><th>Offset<th>Size<th>Field<th>Description<tbody><tr><td>0<td>4<td>Length<td>Length of the encrypted Data<tr><td>4<td>4<td>Key<td>Key to XOR decrypt Data<tr><td>8<td>n<td>Data<td>Encrypted Data</table></div><p>This table shows how each encrypted string and its metadata are stored in the data blob. First the 8 bytes of metadata then the encrypted string data.</p><p>My implementation is split into two projects. First, the runtime, which handles the decryption and stores the encrypted data in the obfuscated binary. The second part is the obfuscator, it injects the runtime into the target binary and handles encrypting the strings as well as rewriting the CIL code to use the string decryption.</p><h2 id="the-runtime"><span class="mr-2">The Runtime</span><a href="#the-runtime" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Starting with the runtime, the part responsible for decrypting strings in the obfuscated binary. I will be using an initialized struct for data storage, basically putting raw byte data into a struct. This method is quite appealing for obfuscation since dnSpy and other decompilers by default only show a field and an empty struct with a fixed size but not the raw content. This means locating the encrypted string data is slightly harder in a standard .NET decompiler.</p><p>The before-mentioned struct and decryption routine are part of the runtime project which is compiled using netstandard 2.0 to ensure compatibility with .NET Core and Framework at the same time. Since we do not know the contents of the struct before encrypting strings I use an empty placeholder struct which will be patched later by the obfuscator.</p><p>Let us take a look at the decryption routine first:</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
</pre><td class="rouge-code"><pre><span class="k">public</span> <span class="k">static</span> <span class="kt">string</span> <span class="nf">Decrypt</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="p">&gt;&gt;</span> <span class="m">31</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span> 
        <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="n">Empty</span><span class="p">;</span>

    <span class="kt">byte</span><span class="p">*</span> <span class="n">data</span> <span class="p">=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">*)</span> <span class="m">0x420</span><span class="p">;</span>
    
    <span class="n">data</span> <span class="p">+=</span> <span class="n">id</span> <span class="p">^</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span><span class="n">data</span><span class="p">;</span>
    
    <span class="kt">byte</span><span class="p">[]</span> <span class="n">buffer</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[*(</span><span class="kt">int</span><span class="p">*)</span> <span class="n">data</span><span class="p">];</span>
    
    <span class="k">fixed</span> <span class="p">(</span><span class="k">void</span><span class="p">*</span> <span class="n">ptr</span> <span class="p">=</span> <span class="p">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="m">0</span><span class="p">])</span>
    <span class="p">{</span>
        
        <span class="nf">cpblk</span><span class="p">(</span><span class="n">data</span> <span class="p">+</span> <span class="m">8</span><span class="p">,</span> <span class="n">ptr</span><span class="p">,</span> <span class="p">(</span><span class="kt">ulong</span><span class="p">)</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">,</span> <span class="p">(</span><span class="kt">ulong</span><span class="p">)</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="kt">int</span> <span class="n">n</span> <span class="p">=</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">-</span> <span class="m">1</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="p">++,</span> <span class="n">n</span><span class="p">--)</span>
    <span class="p">{</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="p">^=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^</span> <span class="p">*(</span><span class="kt">int</span><span class="p">*)</span> <span class="p">(</span><span class="n">data</span> <span class="p">+</span> <span class="m">4</span><span class="p">));</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">^=</span> <span class="n">buffer</span><span class="p">[</span><span class="n">n</span><span class="p">];</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">%</span> <span class="m">2</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>
        <span class="n">buffer</span><span class="p">[</span><span class="n">buffer</span><span class="p">.</span><span class="n">Length</span> <span class="p">&gt;&gt;</span> <span class="m">1</span><span class="p">]</span> <span class="p">^=</span> <span class="p">(</span><span class="kt">byte</span><span class="p">)*(</span><span class="kt">int</span><span class="p">*)</span> <span class="p">(</span><span class="n">data</span> <span class="p">+</span> <span class="m">4</span><span class="p">);</span> <span class="c1">// x &gt;&gt; 1 == x / 2</span>
    
    <span class="k">return</span> <span class="kt">string</span><span class="p">.</span><span class="nf">Intern</span><span class="p">(</span><span class="n">Encoding</span><span class="p">.</span><span class="n">UTF8</span><span class="p">.</span><span class="nf">GetString</span><span class="p">(</span><span class="n">buffer</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// Placeholder for cpblk</span>
<span class="k">private</span> <span class="k">static</span> <span class="k">void</span> <span class="nf">cpblk</span><span class="p">(</span><span class="k">void</span><span class="p">*</span> <span class="n">destination</span><span class="p">,</span> <span class="k">void</span><span class="p">*</span> <span class="n">source</span><span class="p">,</span> <span class="kt">uint</span> <span class="n">bytes</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">throw</span> <span class="k">new</span> <span class="nf">NotImplementedException</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>At the beginning, it verifies that the provided <code class="language-plaintext highlighter-rouge">id</code> parameter is a non-negative value. This is done because in the obfuscator empty strings are replaced with calls to the decryption method but instead of a normal value, a negative value is supplied. Empty strings cannot be encrypted with the current logic hence this exception was added.</p><p>The variable <code class="language-plaintext highlighter-rouge">data</code> is assigned a placeholder value, for now. It will later be patched by the obfuscator with the address of the initialized struct.</p><p>To find the encrypted string in the data blob the <code class="language-plaintext highlighter-rouge">id</code> parameter is decrypted using the global XOR key, which is located at the beginning of the data blob. The decrypted result is the offset at which the encrypted string alongside its metadata is located. The offset is then added to <code class="language-plaintext highlighter-rouge">data</code> the base pointer for the raw data.</p><p>Next, a new array is initialized acting as a buffer for the encrypted string data. The size of the buffer is read from <code class="language-plaintext highlighter-rouge">data</code> by casting it to an int pointer and dereferencing it. Since <code class="language-plaintext highlighter-rouge">data</code> points to the first value of the string format, which is the length of the encrypted string in bytes.</p><p>Using <code class="language-plaintext highlighter-rouge">cpblk</code> the encrypted string bytes are copied into <code class="language-plaintext highlighter-rouge">buffer</code>. The address to copy from is <code class="language-plaintext highlighter-rouge">data</code> with an offset of 8 added, due to the length and the XOR key stored in front of the string data each taking up 4 bytes. The amount of bytes copied is equal to the length of <code class="language-plaintext highlighter-rouge">buffer</code>.</p><p>The <code class="language-plaintext highlighter-rouge">cpblk</code><sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> placeholder method will later be replaced by the obfuscator. It serves as a placeholder for the CIL instruction <code class="language-plaintext highlighter-rouge">cpblk</code> which has no C# implementation and can therefore only be used by patching or manually constructing CIL code.</p><p>After copying the encrypted bytes to <code class="language-plaintext highlighter-rouge">buffer</code> they have to be decrypted. Using a loop with 2 indexing variables <code class="language-plaintext highlighter-rouge">i</code>, which starts at index 0, and <code class="language-plaintext highlighter-rouge">n</code>, which starts at the last element of <code class="language-plaintext highlighter-rouge">buffer</code>. While <code class="language-plaintext highlighter-rouge">i</code> increases with each iteration <code class="language-plaintext highlighter-rouge">n</code> decreases with each iteration. Using the <a href="https://en.wikipedia.org/wiki/XOR_swap_algorithm">XOR swap algorithm</a> on the elements at index <code class="language-plaintext highlighter-rouge">i</code> and <code class="language-plaintext highlighter-rouge">n</code> in the loop we reverse the order of bytes in <code class="language-plaintext highlighter-rouge">buffer</code>.</p><p>At the same time, the swapped byte is decrypted using another XOR with the unique string key which is read by casting <code class="language-plaintext highlighter-rouge">data</code> with an added offset of 4 to an int pointer and dereferencing it. Since the loop does not account for the “middle” byte of odd element count arrays, a check was added to decrypt said byte. First using remainder to check if the element count of <code class="language-plaintext highlighter-rouge">buffer</code> is odd if that is the case get the byte at the index, length of <code class="language-plaintext highlighter-rouge">buffer</code> right shifted by 1 (equivalent to diving by 2). Then XOR decrypt the byte at said index with the unique string key just like in the loop.</p><p>Finally, use <code class="language-plaintext highlighter-rouge">Encoding.UTF8.GetString</code> to convert the decrypted <code class="language-plaintext highlighter-rouge">buffer</code> into a UTF8 formatted string. With <code class="language-plaintext highlighter-rouge">string.Intern</code> to take advantage of the .NET runtimes string caching capabilities.</p><h2 id="the-obfuscator"><span class="mr-2">The Obfuscator</span><a href="#the-obfuscator" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We will use two classes first the StringEncryption class, which is the main part of the obfuscator responsible for parsing the .NET target binary using AsmResolver. The second class we will use is the EncryptionService class which handles encrypting the strings and stores the encrypted data until it is injected into the target binary.</p><p>In the StringEncryption class, we start by injecting the runtime. Using AsmResolvers <code class="language-plaintext highlighter-rouge">MemberCloner</code> to clone the decryption method from our runtime DLL into the target binary. We resolve the injected decryption method, and the placeholder for <code class="language-plaintext highlighter-rouge">cpblk</code> and store the resolved methods for later use.</p><p>After we injected the runtime, we go through all types that have any methods. Next, we iterate over all methods, skipping methods that don’t have a <code class="language-plaintext highlighter-rouge">CilMethodBody</code>. Now we can iterate over the CIL instructions and filter out only <code class="language-plaintext highlighter-rouge">Ldstr</code> instructions. Once we find a <code class="language-plaintext highlighter-rouge">Ldstr</code> instructions we will need the EncryptionService class. It handles the encryption of strings and stores all encrypted Data. It has three properties:</p><div class="table-wrapper"><table><thead><tr><th>Property<th>Description<tbody><tr><td><code class="language-plaintext highlighter-rouge">Index</code><td>Encrypted version of the current offset in the encrypted data blob<tr><td><code class="language-plaintext highlighter-rouge">Length</code><td>The total length of the encrypted data in bytes.<tr><td><code class="language-plaintext highlighter-rouge">Data</code><td>The encrypted data as a byte array.</table></div><p>If the operand of the <code class="language-plaintext highlighter-rouge">Ldstr</code> instruction is an empty string, we do not encrypt it but instead patch the instruction with an <code class="language-plaintext highlighter-rouge">Ldc.I4</code> that has the negated value of <code class="language-plaintext highlighter-rouge">Index</code> as operand. We negate the value since the runtime identifies empty strings by negative values and handles them in the special way discussed in the first part. After we patched the <code class="language-plaintext highlighter-rouge">Ldstr</code> instruction we insert a <code class="language-plaintext highlighter-rouge">call</code> instruction with the injected decryption method as its operand.</p><p>After processing all methods we need to do some patches in the injected runtime. First, we need to set up the placeholder struct with the correct attribute values. The struct needs a <code class="language-plaintext highlighter-rouge">ClassLayout</code> with packing size 1 and the length of the encrypted data as its size.</p><p>We also need to create a new field which will be an initialized version of our struct. By adding a <code class="language-plaintext highlighter-rouge">DataSegment</code> in its <code class="language-plaintext highlighter-rouge">FieldRva</code>, we can use the field to store any raw data we want, in this case, our encrypted string data.</p><p>The last part is patching the placeholder values in the decryption method. For that, we will resolve the <code class="language-plaintext highlighter-rouge">Ldc.I4</code> instruction that has <code class="language-plaintext highlighter-rouge">0x420</code> as its operand and patch it with a <code class="language-plaintext highlighter-rouge">Ldsflda</code> instruction that has our field as its operand. <code class="language-plaintext highlighter-rouge">Ldsflda</code> will push the address of the field on the stack. Since the field holds our data the pushed address will point to the base of our encrypted data blob.</p><p>Additionally, we also need to patch the placeholder for <code class="language-plaintext highlighter-rouge">cpblk</code> for that we simply resolve the call instruction which has the placeholder method as its operand and replace it with a <code class="language-plaintext highlighter-rouge">cpblk</code> instruction. We can then remove the placeholder method since it is no longer required.</p><p>Once we have replaced all placeholders and removed the unused method, we can write the modified target binary to disk. You now have a binary with fully encrypted strings.</p><div class="footnotes" role="doc-endnotes"><ol><li id="fn:1" role="doc-endnote"><p><a href="https://docs.microsoft.com/en-us/dotnet/api/system.reflection.emit.opcodes.cpblk">MS Documentation for cpblk</a> <a href="#fnref:1" class="reversefootnote" role="doc-backlink">&#8617;</a></p></ol></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dotnet/'>dotnet</a>, <a href='/categories/coding/'>coding</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Encrypting+strings+in+.NET+-+dr4k0nia&url=https%3A%2F%2Fdr4k0nia.github.io%2Fposts%2FEncrypting-Strings-In-NET%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NixImports-a-NET-loader-using-HInvoke/">NixImports a .NET loader using HInvoke</a><li><a href="/posts/Analysing-a-sample-of-ArechClient2/">Analysing A Sample Of Arechclient2</a><li><a href="/posts/String-Obfuscation-The-Malware-Way/">String Obfuscation The Malware Way</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Writing-a-Packer/"><div class="card-body"> <em class="small" data-ts="1624545984" data-df="ll" > Jun 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Writing a Packer</h3><div class="text-muted small"><p> Taking a detailed look at my .net executable packer Origami, specifically about the runtime and how it works. Also giving some general overview about packing executables. Basic knowledge of C# and ...</p></div></div></a></div><div class="card"> <a href="/posts/HInvoke-and-avoiding-PInvoke/"><div class="card-body"> <em class="small" data-ts="1660159644" data-df="ll" > Aug 10, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>HInvoke and avoiding PInvoke</h3><div class="text-muted small"><p> A very minimalistic approach of calling .net runtime functions or accessing properties using only hashes as identifiers. It does not leave any strings or import references since we dynamically reso...</p></div></div></a></div><div class="card"> <a href="/posts/String-Obfuscation-The-Malware-Way/"><div class="card-body"> <em class="small" data-ts="1671132444" data-df="ll" > Dec 15, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>String Obfuscation The Malware Way</h3><div class="text-muted small"><p> Malware authors like to use string obfuscation to make their code harder to analyze and detect. One obfuscation technique is to insert special characters into a string, and then use some code to re...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Unpacking-OriginLogger/" class="btn btn-outline-nord" prompt="Older"><p>Unpacking OriginLogger Builder</p></a> <a href="/posts/String-Obfuscation-The-Malware-Way/" class="btn btn-outline-nord" prompt="Newer"><p>String Obfuscation The Malware Way</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/dr4k0nia">dr4k0nia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
