<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Analysing A Sample Of Arechclient2" /><meta property="og:locale" content="en" /><meta name="description" content="In this post, I will be going over my process of analyzing a sample of ArechClient2. Including initial analysis, deobfuscation and unpacking of the loader. Followed by the analysis of the .NET payload revealing its config and C2 information." /><meta property="og:description" content="In this post, I will be going over my process of analyzing a sample of ArechClient2. Including initial analysis, deobfuscation and unpacking of the loader. Followed by the analysis of the .NET payload revealing its config and C2 information." /><link rel="canonical" href="https://dr4k0nia.github.io/posts/Analysing-a-sample-of-ArechClient2/" /><meta property="og:url" content="https://dr4k0nia.github.io/posts/Analysing-a-sample-of-ArechClient2/" /><meta property="og:site_name" content="dr4k0nia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-02-05T00:00:00+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Analysing A Sample Of Arechclient2" /><meta name="twitter:site" content="@dr4k0nia" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-02-05T15:33:44+00:00","datePublished":"2023-02-05T00:00:00+00:00","description":"In this post, I will be going over my process of analyzing a sample of ArechClient2. Including initial analysis, deobfuscation and unpacking of the loader. Followed by the analysis of the .NET payload revealing its config and C2 information.","headline":"Analysing A Sample Of Arechclient2","mainEntityOfPage":{"@type":"WebPage","@id":"https://dr4k0nia.github.io/posts/Analysing-a-sample-of-ArechClient2/"},"url":"https://dr4k0nia.github.io/posts/Analysing-a-sample-of-ArechClient2/"}</script><title>Analysing A Sample Of Arechclient2 | dr4k0nia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dr4k0nia"><meta name="application-name" content="dr4k0nia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/51999910?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">dr4k0nia</a></div><div class="site-subtitle font-italic">Developer & Reverse-Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust" title="Toggle theme"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dr4k0nia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/dr4k0nia" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dr4k0nia','pm.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Analysing A Sample Of Arechclient2</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Analysing A Sample Of Arechclient2</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1675555200" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 5, 2023 </em> </span> <span> Updated <em class="" data-ts="1675611224" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Feb 5, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/dr4k0nia">dr4k0nia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2093 words"> <em>11 min</em> read</span></div></div></div><div class="post-content"><p>In this post, I will be going over my process of analyzing a sample of ArechClient2. Including initial analysis, deobfuscation and unpacking of the loader. Followed by the analysis of the .NET payload revealing its config and C2 information.</p><p>It began with <a href="https://twitter.com/Gi7w0rm/status/1614440406405496836">this tweet</a> by <a href="https://twitter.com/Gi7w0rm">@Gi7w0rm</a>. They mentioned me and a few others asking for help analyzing this sample. I decided to look into the sample. After publishing some threat intel and a few updates on my re progress on Twitter, I decided to write this report for a more detailed documentation of my analysis. The original sample can be found <a href="https://tria.ge/230115-by7fcscb6w">here</a>.</p><h2 id="initial-analysis"><span class="mr-2">Initial Analysis</span><a href="#initial-analysis" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The sample consists of two files, an executable and an a3x file. After some quick research, I found that a3x is a “compiled” form of AutoIt script. The executables icon is the logo of AutoIt and the copyright information says it’s AutoIt. This leads me to believe that this executable is the runtime required to execute the a3x file.</p><p>I ran the file in a Windows Sandbox, for some quick intel and immediately got a Windows Defender hit for <code class="language-plaintext highlighter-rouge">MSIL:Trojan...</code> which indicates that this AutoIt part is just a loader for a second stage .NET binary. In case you are not familiar with the terms, “MSIL” stands for Microsoft Intermediate Language, which is the bytecode that .NET binaries are compiled to.</p><p>The a3x script is human-readable. So after putting it into Visual Studio Code I saw this.</p><p><img data-src="/images/arechclient2/obfuscated_a3x.png" alt="" data-proofer-ignore></p><p>It looks pretty messy at first but taking a closer look I found something that stuck out: The calls to the function called <code class="language-plaintext highlighter-rouge">DoctrineDrama</code> look suspiciously like string decryption. So my next step was to find that function, I used the search function to look for it’s name until I found the actual implementation. All functions start with the keyword <code class="language-plaintext highlighter-rouge">Func</code> and end with the keyword <code class="language-plaintext highlighter-rouge">EndFunc</code>, making it easy for us to identify them. I copied the code of the <code class="language-plaintext highlighter-rouge">DoctrineDrama</code> function to a separate file. The code is obfuscated and seems to contain quite some junk code. My first step was to indent the code, for easier readability.</p><p><img data-src="/images/arechclient2/obfuscated_autoit1.png" alt="" data-proofer-ignore></p><p>Looking at the code, specifically the switch cases inside the loops, I realized that only the branches that use <code class="language-plaintext highlighter-rouge">ExitLoop</code> are of importance. Taking a look at the switch conditions confirmed that suspicion. At the beginning of the function, the second variable is the loop condition, it’s initialized with a value of <code class="language-plaintext highlighter-rouge">921021</code>. Looking at the switch, it matches the case that exits the loop, meaning the other cases are dead code and can be ignored. I removed the dead branches, cleaned up the unnecessary loops and got rid of the unused variables:</p><p><img data-src="/images/arechclient2/obfuscated_autoit2.png" alt="" data-proofer-ignore></p><p>After cleaning up we are left with this code. Reading this we can deduce some more fitting variable names, the first argument seems to be the encrypted input, and the second argument is the key. The first variable is the resulting string. So to understand the rest of the code I looked at the documentation of AutoIt, the <code class="language-plaintext highlighter-rouge">StringSplit</code> function, takes the following arguments: A string, a delimiter char and an optional argument for the delimiter search mode. So the second local variable in <code class="language-plaintext highlighter-rouge">DoctrineDrama</code> is an array of strings split from the input. Next, the code iterates through all the elements of that array and appends a new character to the output string with every iteration. We see a call to a function called <code class="language-plaintext highlighter-rouge">Chr</code>, which according to documentation converts a numeric between 0-255 value to an ASCII character. But something is off, what is going on inside that call to <code class="language-plaintext highlighter-rouge">Chr</code>? subtraction on a string, how does that work? I wondered about that but after a quick web search, I found out that in AutoIt digit only strings seem to be auto-converted to a number if you perform any arithmetic operation on them. Once the loop is finished, the output string is returned.</p><p><img data-src="/images/arechclient2/deobfuscated_autoit.png" alt="" data-proofer-ignore></p><p>Looking at this fully cleaned-up version, I reimplemented the decryption routine in C# to build a simple deobfuscator.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
</pre><td class="rouge-code"><pre><span class="k">static</span> <span class="kt">string</span> <span class="nf">Decrypt</span><span class="p">(</span><span class="kt">string</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">var</span> <span class="n">buffer</span> <span class="p">=</span> <span class="n">input</span><span class="p">.</span><span class="nf">Split</span><span class="p">(</span><span class="sc">'h'</span><span class="p">);</span>
    <span class="kt">var</span> <span class="n">builder</span> <span class="p">=</span> <span class="k">new</span> <span class="nf">StringBuilder</span><span class="p">();</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="n">buffer</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>
    <span class="p">{</span>
        <span class="n">builder</span><span class="p">.</span><span class="nf">Append</span><span class="p">((</span><span class="kt">char</span><span class="p">)(</span><span class="n">Convert</span><span class="p">.</span><span class="nf">ToInt32</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">-</span> <span class="n">key</span><span class="p">));</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">builder</span><span class="p">.</span><span class="nf">ToString</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The deobfuscator uses a simple regex pattern to match every call to <code class="language-plaintext highlighter-rouge">DoctrineDrama</code> and replace it with the decrypted string. It also outputs a list of all decrypted strings. The full deobfuscator code can be found <a href="https://gist.github.com/dr4k0nia/447fb1c5c7e8791ee877fd1090a6f5e5">here</a>.</p><h2 id="dumping-the-payload"><span class="mr-2">Dumping the payload</span><a href="#dumping-the-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After deobfuscating all the strings, I searched the string dump for some Windows API function names that I would expect from a loader. I found a few hits on <code class="language-plaintext highlighter-rouge">NtResumeThread</code>, <code class="language-plaintext highlighter-rouge">CreateProcessW</code> and <code class="language-plaintext highlighter-rouge">NtUnmapViewOfSection</code>. These three in combination give a huge hint towards process hollowing. After searching the string dump for <code class="language-plaintext highlighter-rouge">.exe</code> I found the suspected injection target <code class="language-plaintext highlighter-rouge">\Microsoft.NET\Framework\v4.0.30319\jsc.exe</code>, a utility of .NET Framework 4.x which comes with every standard Windows 10 install.</p><p>My next step was to debug the executable using x64Dbg. I set a breakpoint on <code class="language-plaintext highlighter-rouge">CreateProcessW</code>, to ensure we break before the injection process is started. After running past the entry point I was greeted with this nice little message.</p><p><img data-src="/images/arechclient2/nodebugging.png" alt="" data-proofer-ignore></p><p>The message box claims I violated a EULA which I never read nor agreed to. I guess we can’t debug the malware any further how unfortunate. Luckily for us, x64Dbg has a built-in AutoIt EULA bypass, it’s called Hide Debugger (PEB). You can find it under Debug&gt;Advanded&gt;Hide Debugger (PEB). Make sure to run x64Dbg in elevated mode.</p><p>After dealing with the rather simple anti-debug, we let it run. When debugged, the executable spawns a file dialog asking for an a3x file, when run without a debugger it automatically finds the script file. After pointing it to the script file we let it run until the breakpoint for <code class="language-plaintext highlighter-rouge">CreateProcessW</code> is hit. At this point, <code class="language-plaintext highlighter-rouge">jsc.exe</code> will be started in suspended mode. Checking Process Explorer confirms that the decrypted path from the AutoIt script was indeed the injection target. We add another breakpoint on <code class="language-plaintext highlighter-rouge">NtResumeThread</code> which will break execution after the injection is finished but before the thread is resumed to execute the malware.</p><p><img data-src="/images/arechclient2/jsc_debugging.png" alt="" data-proofer-ignore></p><p>Since we already know the malware is .NET-based I will use ExtremeDumper to get the managed payload from the <code class="language-plaintext highlighter-rouge">jsc.exe</code> process. Run ExtremeDumper as admin and dump <code class="language-plaintext highlighter-rouge">jsc.exe</code>, if it does not show up make sure you are using the x86 version of ExtremeDumper. At the time of writing the loader does not run anymore but fails with an error message about Windows updates. Sifting through the string dump I suspect there is some sort of date check that prevents further execution. This was likely implemented to prevent future analysis. Luckily I had dumped the actual payload before.</p><h2 id="the-net-payload"><span class="mr-2">The .NET Payload</span><a href="#the-net-payload" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After dumping the loader, I had to deal with the managed payload. The image is heavily obfuscated. I started my hunt in the <code class="language-plaintext highlighter-rouge">&lt;Module&gt;</code> class also referred to as the global type. I start by checking this class since its constructor is called before the managed entry point. Many obfuscators call their runtime protections or functions like string decryption here.</p><p>My guess was correct, I found a string decryption method <code class="language-plaintext highlighter-rouge">c</code> in <code class="language-plaintext highlighter-rouge">&lt;Module&gt;</code> (token <code class="language-plaintext highlighter-rouge">0x06000003</code>). The method reads the encrypted string data from an embedded resource and then performs a single XOR operation decryption on it. The key used for decryption is supplied via parameters, which leads me to believe that each string has a unique decryption key.</p><p><img data-src="/images/arechclient2/Pasted image 20230131121307.png" alt="" data-proofer-ignore></p><p>After checking references to <code class="language-plaintext highlighter-rouge">c</code> it turned out that the decryption relies on flow-dependent variables. The calls to the decryption routine have encrypted arguments that are using several opaque predicates and global variables that are initialized and changed depending on call flow.</p><p><img data-src="/images/arechclient2/call_to_string_decryption.png" alt="" data-proofer-ignore></p><p>This means we would have to emulate or solve all calculations required to obtain the local variables and global fields that are used by the expressions that decrypt the arguments of the call to our decryption method <code class="language-plaintext highlighter-rouge">c</code>. The additional dependency on call flow further increases the effort required since we would need to solve all calculations in every method in the correct order. Considering all this I ditched the idea of writing a static string decryption tool.</p><p>Sifting through the binary I found quite a few similarities to Redline, both making use of DataContracts and async tasks for the separate stealer modules.</p><p><img data-src="/images/arechclient2/datacontracts.png" alt="" data-proofer-ignore></p><p>One class in particular seemed interesting. After looking for networking related functions I found a class <code class="language-plaintext highlighter-rouge">cj</code> token <code class="language-plaintext highlighter-rouge">0x0200010C</code> that connects to a server via .NET’s <code class="language-plaintext highlighter-rouge">TcpClient</code>. Looking at the code we can spot the use of another class called <code class="language-plaintext highlighter-rouge">xj</code> which seems to contain the IP and port number for the TCP connection. See line 155 <code class="language-plaintext highlighter-rouge">tcpClient.Connect(xj.c, Convert.ToInt32(xj.a.d)</code></p><p><img data-src="/images/arechclient2/connection_class.png" alt="" data-proofer-ignore></p><p>Apart from that <code class="language-plaintext highlighter-rouge">xj</code> also seems to contain a URL that the malware accesses and downloads a string from, see line 168. Let’s take a closer look at <code class="language-plaintext highlighter-rouge">xj</code> token <code class="language-plaintext highlighter-rouge">0x02000107</code>. It contains quite a few properties but the most interesting is the constructor.</p><p><img data-src="/images/arechclient2/config_constructor.png" alt="" data-proofer-ignore></p><p>This looks like a potential config class. It initializes the properties used for the initial TCP connection and the string download we saw in <code class="language-plaintext highlighter-rouge">cj</code>, which is a good indicator that we are indeed looking at the malwares config. I placed a breakpoint at the end of the constructor. Since the string decryption method was still an issue the easiest way to get the strings was to run the binary and have it decrypt the strings for me. I debugged the executable using dnSpy until I hit the breakpoint at the end of the constructor. After the breakpoint hit we can view all the properties and fields values in the Locals window by expanding the <code class="language-plaintext highlighter-rouge">this</code> parameter.</p><p><img data-src="/images/arechclient2/debugging_config.png" alt="" data-proofer-ignore></p><p>Here we see the C2 IP <code class="language-plaintext highlighter-rouge">77.73.133.83</code> and port <code class="language-plaintext highlighter-rouge">15647</code>. We can also see a Pastebin link, that caught my interest: The paste contains another IP <code class="language-plaintext highlighter-rouge">34.107.35.186</code>, potentially a fallback C2.</p><p>Before debugging, I modified the string decryption method by adding a few lines to write every decrypted string to disk. This modification makes it so that instead of immediately returning the string it’s first passed to <code class="language-plaintext highlighter-rouge">AppendAllText</code> and written to a file of our choice.</p><p><img data-src="/images/arechclient2/Pasted image 20230131130854.png" alt="" data-proofer-ignore></p><p>The dump revealed the same values that we found in the Locals window and a few more strings of interest. For example, we got a list of the paths that the stealer checks for potential credentials. The main targets of this stealer seem to be browsers, mail clients and game clients like Steam. This is similar to most mainstream stealers. You can view the full-string dump <a href="https://pastebin.com/pjBNEQDw">here</a>.</p><p>Speaking of strings, I noticed another similarity to Redline, the use of char array to string conversion at runtime. Although Redline in many cases does insert some additional junk into these arrays that is removed from the constructed string, using the <code class="language-plaintext highlighter-rouge">Replace</code> or <code class="language-plaintext highlighter-rouge">Remove</code> method.</p><p><img data-src="/images/arechclient2/arraytostring.png" alt="" data-proofer-ignore></p><p>Due to the heavy obfuscation and the rather similar behavior to existing stealers, I decided to not investigate this payload further. We revealed the most important IOCs and got a pretty good understanding of the stealer’s targets.</p><h2 id="summary"><span class="mr-2">Summary</span><a href="#summary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>We found that the initial loader was implemented in AutoIt and uses ProcessHollowing to load a .NET-based payload, we reconstructed the string decryption method enabling us to partially deobfuscate the loader. We dumped the managed payload using a debugger and ExtremeDumper. We analyzed and debugged the managed payload to reveal the payload config, containing the C2 information.</p><p>After analyzing the string dump, I found some indicators that could help with attribution to a certain malware family. Although this sample does look very similar to Redline stealer, it is actually not part of that family. I found this blob of data that looked suspiciously like C2 communication:</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>{"Type":"ConnectionType","ConnectionType":"Client","SessionID":"
","BotName":"
","BuildID":"
","BotOS":
"Caption","URLData":"
","UIP":"
"}
</pre></table></code></div></div><p>Referencing the above data and the port number to other writeups, like <a href="https://www.ironnet.com/blog/key-findings-from-defending-the-noc-at-black-hat-europe-2022">this one</a> from IronNet Threat Research, revealed similarities to a different malware family. The screenshot below shows a network capture of an active ArechClient2 sample performed by the researchers from IronNet. Comparing this data we can conclude that our sample is also part of the ArechClient2 family.</p><p><img data-src="https://www.ironnet.com/hs-fs/hubfs/NOC_BHEU2022_3.png?width=1809&amp;height=1044&amp;name=NOC_BHEU2022_3.png" alt="" data-proofer-ignore> <em><a href="https://www.ironnet.com/blog/key-findings-from-defending-the-noc-at-black-hat-europe-2022">image source</a></em></p><p>With this we have reached the end of our analysis. Below, I have arranged all important IOCs, for the threat intel focused readers. I write these reports in my freetime and publish them for free, if you want to support my work feel free to sponsor me on <a href="https://github.com/dr4k0nia">GitHub</a>.</p><h2 id="iocs"><span class="mr-2">IOCs</span><a href="#iocs" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><div class="table-wrapper"><table><thead><tr><th>Description<th>Indicator<tbody><tr><td>C2<td><code class="language-plaintext highlighter-rouge">77.73.133.83:15647</code><tr><td>Potential Fallback C2<td><code class="language-plaintext highlighter-rouge">34.107.35.186:15647</code><tr><td>URL for fallback C2<td><code class="language-plaintext highlighter-rouge">https://pastebin.com/raw/NdY0fAXm</code><tr><td>.NET payload <code class="language-plaintext highlighter-rouge">Test.exe</code><td>SHA256: <code class="language-plaintext highlighter-rouge">a835602db71a42876d0a88cc452cb60001de4875a5e91316da9a74363f481910</code><tr><td>AutoIt loader <code class="language-plaintext highlighter-rouge">45.exe</code><td>SHA256: <code class="language-plaintext highlighter-rouge">237d1bca6e056df5bb16a1216a434634109478f882d3b1d58344c801d184f95d</code><tr><td>AutoIt script <code class="language-plaintext highlighter-rouge">S.a3x</code><td>SHA256: <code class="language-plaintext highlighter-rouge">8e289b8dfc7e4994d808ef79a88adb513365177604fe587f6efa812f284e21a3</code></table></div></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Analysing+A+Sample+Of+Arechclient2+-+dr4k0nia&url=https%3A%2F%2Fdr4k0nia.github.io%2Fposts%2FAnalysing-a-sample-of-ArechClient2%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NixImports-a-NET-loader-using-HInvoke/">NixImports a .NET loader using HInvoke</a><li><a href="/posts/Analysing-a-sample-of-ArechClient2/">Analysing A Sample Of Arechclient2</a><li><a href="/posts/String-Obfuscation-The-Malware-Way/">String Obfuscation The Malware Way</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/NixImports-a-NET-loader-using-HInvoke/"><div class="card-body"> <em class="small" data-ts="1684762044" data-df="ll" > May 22, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NixImports a .NET loader using HInvoke</h3><div class="text-muted small"><p> A while ago, I released HInvoke, a project showcasing API hashing for managed functions. The initial release was rather basic and lacked desirable features like support for non-static methods. NixI...</p></div></div></a></div><div class="card"> <a href="/posts/Unpacking-RedLine-Stealer/"><div class="card-body"> <em class="small" data-ts="1672838844" data-df="ll" > Jan 4, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unpacking RedLine Stealer</h3><div class="text-muted small"><p> In this post, we are going to take a look at Redline Stealer, a well-known .NET based credential stealer. I will focus on unpacking the managed payload and extracting it’s config, for a more detail...</p></div></div></a></div><div class="card"> <a href="/posts/String-Obfuscation-The-Malware-Way/"><div class="card-body"> <em class="small" data-ts="1671132444" data-df="ll" > Dec 15, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>String Obfuscation The Malware Way</h3><div class="text-muted small"><p> Malware authors like to use string obfuscation to make their code harder to analyze and detect. One obfuscation technique is to insert special characters into a string, and then use some code to re...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Unpacking-RedLine-Stealer/" class="btn btn-outline-nord" prompt="Older"><p>Unpacking RedLine Stealer</p></a> <a href="/posts/NixImports-a-NET-loader-using-HInvoke/" class="btn btn-outline-nord" prompt="Newer"><p>NixImports a .NET loader using HInvoke</p></a></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/dr4k0nia">dr4k0nia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
