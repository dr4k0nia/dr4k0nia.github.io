<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="NixImports a .NET loader using HInvoke" /><meta property="og:locale" content="en" /><meta name="description" content="A while ago, I released HInvoke, a project showcasing API hashing for managed functions. The initial release was rather basic and lacked desirable features like support for non-static methods. NixImports is an example showing the use of the new HInvoke. The update includes support for non-static methods as well as support for nonunique method names. In this blog post, I will describe the improvements and showcase the use of HInvoke in a simple .NET loader." /><meta property="og:description" content="A while ago, I released HInvoke, a project showcasing API hashing for managed functions. The initial release was rather basic and lacked desirable features like support for non-static methods. NixImports is an example showing the use of the new HInvoke. The update includes support for non-static methods as well as support for nonunique method names. In this blog post, I will describe the improvements and showcase the use of HInvoke in a simple .NET loader." /><link rel="canonical" href="https://dr4k0nia.github.io/posts/NixImports-a-NET-loader-using-HInvoke/" /><meta property="og:url" content="https://dr4k0nia.github.io/posts/NixImports-a-NET-loader-using-HInvoke/" /><meta property="og:site_name" content="dr4k0nia" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-22T13:27:24+00:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="NixImports a .NET loader using HInvoke" /><meta name="twitter:site" content="@dr4k0nia" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-22T20:09:15+00:00","datePublished":"2023-05-22T13:27:24+00:00","description":"A while ago, I released HInvoke, a project showcasing API hashing for managed functions. The initial release was rather basic and lacked desirable features like support for non-static methods. NixImports is an example showing the use of the new HInvoke. The update includes support for non-static methods as well as support for nonunique method names. In this blog post, I will describe the improvements and showcase the use of HInvoke in a simple .NET loader.","headline":"NixImports a .NET loader using HInvoke","mainEntityOfPage":{"@type":"WebPage","@id":"https://dr4k0nia.github.io/posts/NixImports-a-NET-loader-using-HInvoke/"},"url":"https://dr4k0nia.github.io/posts/NixImports-a-NET-loader-using-HInvoke/"}</script><title>NixImports a .NET loader using HInvoke | dr4k0nia</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="dr4k0nia"><meta name="application-name" content="dr4k0nia"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="https://avatars.githubusercontent.com/u/51999910?v=4" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">dr4k0nia</a></div><div class="site-subtitle font-italic">Developer & Reverse-Engineer</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust" title="Toggle theme"></i> </button> <span class="icon-border"></span> <a href="https://github.com/dr4k0nia" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/dr4k0nia" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['dr4k0nia','pm.me'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>NixImports a .NET loader using HInvoke</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4 pb-5"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>NixImports a .NET loader using HInvoke</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1684762044" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 22, 2023 </em> </span> <span> Updated <em class="" data-ts="1684786155" data-df="ll" data-toggle="tooltip" data-placement="bottom"> May 22, 2023 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="https://twitter.com/dr4k0nia">dr4k0nia</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1514 words"> <em>8 min</em> read</span></div></div></div><div class="post-content"><p>A while ago, I released <a href="https://dr4k0nia.github.io/posts/HInvoke-and-avoiding-PInvoke/">HInvoke</a>, a project showcasing API hashing for managed functions. The initial release was rather basic and lacked desirable features like support for non-static methods. NixImports is an example showing the use of the new HInvoke. The update includes support for non-static methods as well as support for nonunique method names. In this blog post, I will describe the improvements and showcase the use of HInvoke in a simple .NET loader.</p><h2 id="the-concept"><span class="mr-2">The Concept</span><a href="#the-concept" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>NixImports aims to build a loader with little to no direct function calls and reduce referenced methods to a minimum. Importing a function in .NET adds some metadata, for example, the namespace and name of the referenced method. This metadata gives away potential capabilities of our binary and can be used for detection, see for example, GDATA’s <a href="https://www.gdatasoftware.com/blog/2020/06/36164-introducing-the-typerefhash-trh">TypeRefHash</a>. To avoid this kind of metadata as much as possible, NixImports uses my managed API hashing implementation HInvoke. HInvoke does not require the method we want to invoke to be referenced in the assembly; instead, it will dynamically resolve the method or property on runtime, using only two hash values to identify the target method.</p><h3 id="hinvoke"><span class="mr-2">HInvoke</span><a href="#hinvoke" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>As mentioned above HInvoke requires two hash values. The first hash identifies the <code class="language-plaintext highlighter-rouge">FullName</code> of the type containing our targetted member. The second hash identifies the method or property we want to access. To resolve the desired type and member, HInvoke iterates through all types of <code class="language-plaintext highlighter-rouge">mscorlib</code> and generates a hash for each type name; once a matching hash is found, it will iterate through all methods or properties of that type and hash their name or in case of methods <code class="language-plaintext highlighter-rouge">ToString</code> value. If the hash matches the supplied second hash, we return the property value or invoke the method and return its result. HInvoke also accepts arguments for the to-be-called method and an instance object for methods and properties. Using the instance object, HInvoke can invoke non-static methods or get properties of instantiated types. To minimize overhead, I added a cache that holds previously resolved member info to avoid expensive re-parsing of <code class="language-plaintext highlighter-rouge">mscorlib</code>.</p><h3 id="storing-payload-data"><span class="mr-2">Storing Payload Data</span><a href="#storing-payload-data" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Besides hiding imports, I wanted to have fun hiding the payload data. We take the payload data and split it into smaller chunks. Next, we Base64 encode the chunks as strings. The encoded strings are then encrypted with a simple ROT cipher and used as names for newly injected methods. The injected methods contain some placeholder code but serve no purpose except storing payload data in their name. During runtime, we ensure the correct order of methods and decrypt the names before converting them back to bytes through Base64 decoding. To make sure we parse the methods in the correct order, I use AsmResolvers <code class="language-plaintext highlighter-rouge">TokenAllocator</code>, which allows us to pre-assign tokens to injected methods. After adding the payload data, I patch the loader stub replacing placeholder values with the pre-assigned tokens.</p><h2 id="the-runtime"><span class="mr-2">The Runtime</span><a href="#the-runtime" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now let us look at the most exciting part of NixImports, the actual loader code. The loader utilizes HInvoke to conceal its function calls and deliberately avoids using traditional functions that analysis tools and EDR software may detect. Wherever possible, NixImports uses the underlying internal functions instead of the public functions. For example, it uses <code class="language-plaintext highlighter-rouge">RuntimeAssembly.nLoadImage</code> instead of <code class="language-plaintext highlighter-rouge">Assembly.Load</code>. If you take a look at <code class="language-plaintext highlighter-rouge">Assembly.Load</code> in a decompiler you will see that it performs some sanity checks before calling <code class="language-plaintext highlighter-rouge">RuntimeAssembly.nLoadImage</code>. We skip the sanity checks and call the internal function directly.</p><p>Let us take a look at the code responsible for parsing the Base64 encoded method names.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
</pre><td class="rouge-code"><pre><span class="kt">byte</span><span class="p">[]</span> <span class="n">payload</span> <span class="p">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="p">[</span><span class="m">0x1337</span><span class="p">];</span>  
<span class="kt">int</span> <span class="n">offset</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span>  
<span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="p">=</span> <span class="m">0x1338</span><span class="p">;</span> <span class="n">i</span> <span class="p">&lt;</span> <span class="m">0x1339</span><span class="p">;</span> <span class="n">i</span><span class="p">++)</span>  
<span class="p">{</span>  
    <span class="n">MethodBase</span> <span class="n">baseMethod</span> <span class="p">=</span> <span class="n">InvokeMethod</span><span class="p">&lt;</span><span class="n">MethodBase</span><span class="p">&gt;(</span><span class="m">1274687369</span><span class="p">,</span> <span class="m">1074927592</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">?[]</span> <span class="p">{</span> <span class="n">i</span> <span class="p">},</span> <span class="n">module</span><span class="p">);</span> 
    <span class="kt">string</span> <span class="n">name</span> <span class="p">=</span> <span class="n">GetPropValue</span><span class="p">&lt;</span><span class="kt">string</span><span class="p">&gt;(</span><span class="m">4243846143</span><span class="p">,</span> <span class="m">1642051212</span><span class="p">,</span> <span class="n">baseMethod</span><span class="p">);</span> 
    <span class="k">fixed</span> <span class="p">(</span><span class="kt">char</span><span class="p">*</span> <span class="n">ptr</span> <span class="p">=</span> <span class="n">name</span><span class="p">)</span>  
    <span class="p">{</span>        
	    <span class="kt">int</span> <span class="n">length</span> <span class="p">=</span> <span class="n">GetPropValue</span><span class="p">&lt;</span><span class="kt">int</span><span class="p">&gt;(</span><span class="m">1845477325</span><span class="p">,</span> <span class="m">4202415711</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="p">=</span> <span class="m">0</span><span class="p">;</span> <span class="n">j</span> <span class="p">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">j</span><span class="p">++)</span>  
        <span class="p">{</span>            
	        <span class="n">ptr</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="p">-=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)(</span><span class="n">_methodCache</span><span class="p">.</span><span class="n">Keys</span><span class="p">.</span><span class="nf">ToArray</span><span class="p">()[</span><span class="m">0</span><span class="p">]</span> <span class="p">%</span> <span class="m">100</span> <span class="p">-</span> <span class="m">30</span><span class="p">);</span>  
        <span class="p">}</span>  
        <span class="kt">byte</span><span class="p">[]</span> <span class="n">data</span> <span class="p">=</span> <span class="nf">base64FromCharPtr</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>  
        <span class="n">InvokeMethod</span><span class="p">&lt;</span><span class="kt">short</span><span class="p">&gt;(</span><span class="m">2132718223</span><span class="p">,</span> <span class="m">4285503295</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">?[]</span> <span class="p">{</span> <span class="n">payload</span><span class="p">,</span> <span class="n">offset</span> <span class="p">},</span> <span class="n">data</span><span class="p">);</span>
        <span class="n">offset</span> <span class="p">+=</span> <span class="n">data</span><span class="p">.</span><span class="n">Length</span><span class="p">;</span>  
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p><em>Note that <code class="language-plaintext highlighter-rouge">0x133X</code> values are temporary placeholders and will be replaced after injection. The <code class="language-plaintext highlighter-rouge">base64FromCharPtr</code> delegate is dynamically initialized and resolved via HInvoke.</em></p><p>All notable calls have been replaced with a call to the HInvoke handler, leaving only the return type as an obvious indicator of its purpose. It’s important to note that the return type cannot be relied upon because we can select any type we want as the generic parameter if the method does not have a return value. Before writing the final image to disk, the packer will also rename all members in the runtime to random Unicode strings, further obscuring the code.</p><p>As described above, this code loops through all methods that contain payload data. It uses <code class="language-plaintext highlighter-rouge">MetadataToken</code> values to resolve the methods using Reflection. The first handler resolves the method the second handler retrieves its name. Then we get a pointer to the string and decrypt it char by char using a slightly obscured subtraction of <code class="language-plaintext highlighter-rouge">65</code>, the numeric value of the uppercase A in the ASCII encoding. After decrypting the string, we use the dynamically resolved delegate <code class="language-plaintext highlighter-rouge">base64FromCharPtr</code> to convert the Base64 string back to bytes. The resulting byte array is then copied into the large array initialized at the top, which will later contain the entire payload image.</p><div class="language-csharp highlighter-rouge"><div class="code-header"> <span data-label-text="C#"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kt">var</span> <span class="n">assembly</span> <span class="p">=</span>  
    <span class="n">InvokeMethod</span><span class="p">&lt;</span><span class="n">Assembly</span><span class="p">&gt;(</span><span class="m">3909091325</span><span class="p">,</span> <span class="m">1082111880</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span> <span class="c1">//System.Reflection.RuntimeAssembly.nLoadImage  </span>
  
<span class="kt">var</span> <span class="n">entryPoint</span> <span class="p">=</span>  
    <span class="n">GetPropValue</span><span class="p">&lt;</span><span class="n">MethodInfo</span><span class="p">&gt;(</span><span class="m">4078926558</span><span class="p">,</span> <span class="m">3155696631</span><span class="p">,</span> <span class="n">assembly</span><span class="p">);</span> <span class="c1">// System.Reflection.Runtime.EntryPoint  </span>
  
<span class="kt">object</span><span class="p">[]</span> <span class="n">parameters</span> <span class="p">=</span>  
    <span class="k">new</span> <span class="kt">object</span><span class="p">[</span><span class="n">InvokeMethod</span><span class="p">&lt;</span><span class="n">ParameterInfo</span><span class="p">[</span><span class="k">]&gt;</span><span class="p">(</span><span class="m">1891508174</span><span class="p">,</span> <span class="m">4164820959</span><span class="p">,</span> <span class="k">null</span><span class="p">,</span> <span class="n">entryPoint</span><span class="p">).</span><span class="n">Length</span><span class="p">];</span>  
<span class="k">if</span> <span class="p">(</span><span class="n">parameters</span><span class="p">.</span><span class="n">Length</span> <span class="p">!=</span> <span class="m">0</span><span class="p">)</span>  
    <span class="n">parameters</span><span class="p">[</span><span class="m">0</span><span class="p">]</span> <span class="p">=</span> <span class="n">args</span><span class="p">;</span>  
<span class="n">InvokeMethod</span><span class="p">&lt;</span><span class="kt">object</span><span class="p">&gt;(</span><span class="m">1891508174</span><span class="p">,</span> <span class="m">4026509245</span><span class="p">,</span> <span class="k">new</span> <span class="kt">object</span><span class="p">?[]</span> <span class="p">{</span> <span class="k">null</span><span class="p">,</span> <span class="n">parameters</span> <span class="p">},</span>  
    <span class="n">entryPoint</span><span class="p">);</span> <span class="c1">// System.Reflection.MethodBase.Invoke(object, object[])</span>
</pre></table></code></div></div><p>After the image has been reconstructed, it is loaded into our <code class="language-plaintext highlighter-rouge">AppDomain</code> using <code class="language-plaintext highlighter-rouge">nLoadImage</code>. Next, the entry point is resolved and called, passing any command line arguments supplied to the loader stub to the payload. Support for dynamic libraries is not implemented since they do not have an <code class="language-plaintext highlighter-rouge">EntryPoint</code> property. Pull requests are always appreciated if you would like to add support for dynamic libraries.</p><h2 id="the-analysts-perspective"><span class="mr-2">The Analysts Perspective</span><a href="#the-analysts-perspective" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now let us take a look at a packed image produced by NixImports in dnSpy. Apart from reducing import references HInvoke also does a great job as an obfuscator. As we can see most of the code is made up of calls to HInvoke handlers. We can see some return types of the handler methods but no direct references to any functions. The renaming obfuscation applied makes the code even less readable.</p><p><img data-src="/images/niximports/nix_loader_dnSpy.png" alt="" data-proofer-ignore></p><p>Most analyst’s first thought would likely be to run the binary through de4dot. However, de4dot would destroy the loader by renaming the methods containing the encoded payload bytes, a nice side effect increasing the difficulty of pure static analysis.</p><p><img data-src="/images/niximports/nix_references.png" alt="" data-proofer-ignore></p><p>By checking the Type References in dnSpy, we can evaluate the imported types and their members. This info can give some valuable insights into the capabilities of a program. Using HInvoke, we should not find any references to the methods and properties we accessed through its handlers. Let us check:</p><ul><li><code class="language-plaintext highlighter-rouge">Assembly</code> is imported but only references <code class="language-plaintext highlighter-rouge">GetTypes</code>, with no references to dynamic assembly loading.<li>The assembly contains no references to <code class="language-plaintext highlighter-rouge">Convert</code> which contains Base64 encoding-related methods</ul><p>Success! The loader’s assembly is missing typical indicators that one would expect to be present in a loader. In case you want to use it or experiment with it yourself, checkout the <a href="https://github.com/dr4k0nia/NixImports">GitHub repository</a></p><h2 id="tips-for-defenders"><span class="mr-2">Tips for Defenders</span><a href="#tips-for-defenders" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>After discussing how NixImports operates, let’s now examine potential detection methods. The current implementation has a few flaws, that allow for static detection. A few indicators that come to mind when I thought about possible detection are:</p><ul><li>Hardcoded hash values used within the code<li>The hashing algorithm itself<li>Hardcoded encryption: We can search for known text values, since we know what they will be in their encrypted form.</ul><p>Based on these indicators, I created a simple Yara rule. The rule consists of two patterns. The first one represents the encoded MZ header of the payload . The second pattern covers the initialization of the delegate for <code class="language-plaintext highlighter-rouge">Base64FromCharPtr</code>, which happens right at the beginning of the loader code. The <code class="language-plaintext highlighter-rouge">$a</code> strings represent imports required by HInvoke.</p><div class="language-text highlighter-rouge"><div class="code-header"> <span data-label-text="Text"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>rule MAL_Msil_Net_NixImports_Loader {
   meta:
      description = "Detects NixImports .NET loader"
      author = "dr4k0nia"
      date = "2023-05-21"
      reference = "https://github.com/dr4k0nia/NixImports"
   strings:
      $op_pe = {C2 95 C2 97 C2 B2 C2 92 C2 82 C2 82 C2 8E C2 82 C2 82 C2 82 C2 82 C2 86 C2 82} // PE magic
      $op_delegate = {20 F0 C7 FF 80 20 83 BF 7F 1F 14 14} // delegate initialization arguments

      // Imports that will be present due to HInvoke
      $a1 = "GetRuntimeProperties" ascii fullword
      $a2 = "GetTypes" ascii fullword
      $a3 = "GetRuntimeMethods" ascii fullword
      $a4 = "netstandard" ascii fullword
   condition:
      uint16(0) == 0x5a4d
      and filesize &lt; 3MB
      and all of ($a*)
      and 2 of ($op*)
}
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/dotnet/'>dotnet</a>, <a href='/categories/malware/'>malware</a>, <a href='/categories/redteam/'>redteam</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=NixImports+a+.NET+loader+using+HInvoke+-+dr4k0nia&url=https%3A%2F%2Fdr4k0nia.github.io%2Fposts%2FNixImports-a-NET-loader-using-HInvoke%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/NixImports-a-NET-loader-using-HInvoke/">NixImports a .NET loader using HInvoke</a><li><a href="/posts/Analysing-a-sample-of-ArechClient2/">Analysing A Sample Of Arechclient2</a><li><a href="/posts/String-Obfuscation-The-Malware-Way/">String Obfuscation The Malware Way</a></ul></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mb-2 mb-sm-4"><h3 class="pt-2 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/String-Obfuscation-The-Malware-Way/"><div class="card-body"> <em class="small" data-ts="1671132444" data-df="ll" > Dec 15, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>String Obfuscation The Malware Way</h3><div class="text-muted small"><p> Malware authors like to use string obfuscation to make their code harder to analyze and detect. One obfuscation technique is to insert special characters into a string, and then use some code to re...</p></div></div></a></div><div class="card"> <a href="/posts/Unpacking-RedLine-Stealer/"><div class="card-body"> <em class="small" data-ts="1672838844" data-df="ll" > Jan 4, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Unpacking RedLine Stealer</h3><div class="text-muted small"><p> In this post, we are going to take a look at Redline Stealer, a well-known .NET based credential stealer. I will focus on unpacking the managed payload and extracting it’s config, for a more detail...</p></div></div></a></div><div class="card"> <a href="/posts/Writing-a-Packer/"><div class="card-body"> <em class="small" data-ts="1624545984" data-df="ll" > Jun 24, 2021 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Writing a Packer</h3><div class="text-muted small"><p> Taking a detailed look at my .net executable packer Origami, specifically about the runtime and how it works. Also giving some general overview about packing executables. Basic knowledge of C# and ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Analysing-a-sample-of-ArechClient2/" class="btn btn-outline-nord" prompt="Older"><p>Analysing A Sample Of Arechclient2</p></a><div class="btn btn-outline-nord disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="row pl-3 pr-3"><div class="col-12 d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://twitter.com/dr4k0nia">dr4k0nia</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
